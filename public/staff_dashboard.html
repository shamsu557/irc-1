<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="staffDashboard">Staff Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Amiri:wght@400;700&display=swap');
        :root {
            --primary-color: #00897b;
            --secondary-color: #2f4f4f;
            --light-color: #f0f8f0;
            --white-color: #ffffff;
            --card-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--light-color);
            color: var(--secondary-color);
            min-height: 100vh;
        }
        .text-arabic {
            font-family: 'Amiri', serif;
        }
        .sidebar {
            background-color: var(--secondary-color);
            color: var(--white-color);
            min-height: 100vh;
            padding: 2rem 1rem;
        }
        .sidebar .nav-link {
            color: var(--white-color);
            margin-bottom: 1rem;
            transition: color 0.3s;
        }
        .sidebar .nav-link:hover {
            color: var(--light-color);
        }
        .dashboard-container {
            max-width: 1400px;
            margin: 2rem auto;
            background-color: var(--white-color);
            border-radius: 1.5rem;
            box-shadow: var(--card-shadow);
            padding: 2rem;
        }
        .card {
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 1rem;
        }
        .btn-primary-custom {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: var(--white-color);
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .btn-primary-custom:hover {
            background-color: #00695c;
            border-color: #00695c;
            transform: translateY(-2px);
        }
        .btn-lang-toggle {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
            color: var(--white-color);
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .btn-lang-toggle:hover {
            background-color: #1a2f2f;
            border-color: #1a2f2f;
            color: var(--white-color);
            transform: translateY(-2px);
        }
        .alert-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1050;
        }
        .modal-header {
            border-bottom: none;
        }
        .custom-badge {
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
            border-radius: 1rem;
            display: inline-block;
            margin: 0.25rem;
        }
        .custom-badge-primary {
            background-color: var(--primary-color);
            color: var(--white-color);
        }
        @media (max-width: 768px) {
            .dashboard-container {
                margin: 1rem;
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar">
                <div class="position-sticky pt-3">
                    <h4 class="text-white" data-translate="staffPanel">Staff Panel</h4>
                    <p data-translate="role">Role: <span id="userRole">N/A</span></p>
                    <p data-translate="staffId">Staff ID: <span id="userName">N/A</span></p>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#dashboard" data-translate="dashboard">Dashboard</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#my-classes" data-translate="myClasses">My Classes</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#students" data-translate="students">Students</a>
                        </li>
                        <li class="nav-item" id="attendanceNav" style="display: none;">
                            <a class="nav-link" href="#attendance" data-translate="attendance">Attendance</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#assessments" data-translate="assessments">Assessments</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#memorization" data-translate="memorization">Memorization</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="signOut()" data-translate="signOut">Sign out</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="dashboard-container">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2" data-translate="staffDashboard">Staff Dashboard</h1>
                        <button id="langToggle" class="btn btn-lang-toggle rounded-pill px-4 py-2 shadow-sm text-white" data-translate="toggleLanguage">العربية</button>
                    </div>

                    <!-- Dashboard Overview -->
                    <section id="dashboard" class="mb-5">
                        <h3 data-translate="dashboardOverview">Dashboard Overview</h3>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="card text-center p-3">
                                    <h5 data-translate="totalClasses">Total Classes</h5>
                                    <h2 id="totalClasses">0</h2>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center p-3">
                                    <h5 data-translate="totalStudents">Total Students</h5>
                                    <h2 id="totalStudents">0</h2>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center p-3">
                                    <h5 data-translate="attendanceToday">Attendance Today</h5>
                                    <h2 id="attendanceToday">0%</h2>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center p-3">
                                    <h5 data-translate="averageGrade">Average Grade</h5>
                                    <h2 id="averageGrade">0</h2>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- My Classes -->
                    <section id="my-classes" class="mb-5">
                        <h3 data-translate="myClasses">My Classes</h3>
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th data-translate="className">Class Name</th>
                                    <th data-translate="level">Level</th>
                                    <th data-translate="students">Students</th>
                                    <th data-translate="actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="classesTableBody">
                                <!-- Classes will be populated here -->
                            </tbody>
                        </table>
                    </section>

                    <!-- Students -->
                    <section id="students" class="mb-5">
                        <h3 data-translate="students">Students</h3>
                        <select id="classSelect" class="form-select mb-3">
                            <option value="" data-translate="selectClass">Select Class</option>
                        </select>
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th data-translate="name">Name</th>
                                    <th data-translate="gender">Gender</th>
                                    <th data-translate="actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="studentsTableBody">
                                <!-- Students will be populated here -->
                            </tbody>
                        </table>
                    </section>

                    <!-- Attendance -->
                    <section id="attendance" class="mb-5" style="display: none;">
                        <h3 data-translate="attendance">Attendance</h3>
                        <input type="date" id="attendanceDate" class="form-control mb-3">
                        <select id="attendanceDay" class="form-select mb-3">
                            <option value="" data-translate="selectDay">Select Day</option>
                            <option value="Monday">Monday</option>
                            <option value="Tuesday">Tuesday</option>
                            <option value="Wednesday">Wednesday</option>
                            <option value="Thursday">Thursday</option>
                            <option value="Friday">Friday</option>
                            <option value="Saturday">Saturday</option>
                            <option value="Sunday">Sunday</option>
                        </select>
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th data-translate="studentName">Student Name</th>
                                    <th data-translate="status">Status</th>
                                </tr>
                            </thead>
                            <tbody id="attendanceTableBody">
                                <!-- Attendance rows will be populated here -->
                            </tbody>
                        </table>
                        <button class="btn btn-primary-custom" onclick="saveAttendance()" data-translate="saveAttendance">Save Attendance</button>
                    </section>

                    <!-- Assessments -->
                    <section id="assessments" class="mb-5">
                        <h3 data-translate="assessments">Assessments</h3>
                        <select id="assessmentClassSelect" class="form-select mb-3">
                            <option value="" data-translate="selectClass">Select Class</option>
                        </select>
                        <select id="assessmentSubjectSelect" class="form-select mb-3">
                            <option value="" data-translate="selectSubject">Select Subject</option>
                        </select>
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th data-translate="studentName">Student Name</th>
                                    <th data-translate="ca1">CA1</th>
                                    <th data-translate="ca2">CA2</th>
                                    <th data-translate="ca3">CA3</th>
                                    <th data-translate="exam">Exam</th>
                                    <th data-translate="comments">Comments</th>
                                </tr>
                            </thead>
                            <tbody id="assessmentsTableBody">
                                <!-- Assessment rows will be populated here -->
                            </tbody>
                        </table>
                        <button class="btn btn-primary-custom" onclick="saveAssessments()" data-translate="saveAssessments">Save Assessments</button>
                    </section>

                    <!-- Memorization -->
                    <section id="memorization" class="mb-5">
                        <h3 data-translate="memorization">Memorization</h3>
                        <select id="memorizationClassSelect" class="form-select mb-3">
                            <option value="" data-translate="selectClass">Select Class</option>
                        </select>
                        <select id="memorizationSchemeSelect" class="form-select mb-3">
                            <option value="" data-translate="selectScheme">Select Memorization Scheme</option>
                        </select>
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th data-translate="studentName">Student Name</th>
                                    <th data-translate="week">Week</th>
                                    <th data-translate="day">Day</th>
                                    <th data-translate="fromAyah">From Ayah</th>
                                    <th data-translate="toAyah">To Ayah</th>
                                    <th data-translate="dailyGrade">Daily Grade</th>
                                    <th data-translate="examGrade">Exam Grade</th>
                                    <th data-translate="comments">Comments</th>
                                </tr>
                            </thead>
                            <tbody id="memorizationTableBody">
                                <!-- Memorization rows will be populated here -->
                            </tbody>
                        </table>
                        <button class="btn btn-primary-custom" onclick="saveMemorization()" data-translate="saveProgress">Save Progress</button>
                    </section>
                </div>
            </main>
        </div>
    </div>

    <!-- Message Modal -->
    <div class="modal fade" id="messageModal" tabindex="-1" aria-labelledby="messageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-xl shadow-2xl">
                <div class="modal-header">
                    <h5 class="modal-title font-bold text-gray-800" id="messageModalLabel">Message</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-6">
                    <p id="messageText" class="text-gray-700"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal" data-translate="close">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const translations = {
            en: {
                staffDashboard: "Staff Dashboard",
                staffPanel: "Staff Panel",
                toggleLanguage: "العربية",
                role: "Role",
                staffId: "Staff ID",
                dashboard: "Dashboard",
                myClasses: "My Classes",
                students: "Students",
                attendance: "Attendance",
                assessments: "Assessments",
                memorization: "Memorization",
                signOut: "Sign out",
                dashboardOverview: "Dashboard Overview",
                totalClasses: "Total Classes",
                totalStudents: "Total Students",
                attendanceToday: "Attendance Today",
                averageGrade: "Average Grade",
                className: "Class Name",
                level: "Level",
                students: "Students",
                actions: "Actions",
                name: "Name",
                gender: "Gender",
                selectClass: "Select Class",
                selectSubject: "Select Subject",
                selectScheme: "Select Memorization Scheme",
                selectDay: "Select Day",
                studentName: "Student Name",
                status: "Status",
                ca1: "CA1",
                ca2: "CA2",
                ca3: "CA3",
                exam: "Exam",
                comments: "Comments",
                week: "Week",
                day: "Day",
                fromAyah: "From Ayah",
                toAyah: "To Ayah",
                dailyGrade: "Daily Grade",
                examGrade: "Exam Grade",
                saveAttendance: "Save Attendance",
                saveAssessments: "Save Assessments",
                saveProgress: "Save Progress",
                close: "Close",
                view: "View",
                errors: {
                    unauthorized: "You are not authorized. Please log in again.",
                    serverError: "Failed to connect to the server.",
                    fetchError: "Failed to fetch data.",
                    saveError: "Failed to save data.",
                    logoutError: "Logout failed.",
                    notFormMaster: "You are not the form master for this class."
                }
            },
            ar: {
                staffDashboard: "لوحة تحكم الموظفين",
                staffPanel: "لوحة الموظفين",
                toggleLanguage: "English",
                role: "الدور",
                staffId: "معرف الموظف",
                dashboard: "لوحة التحكم",
                myClasses: "فصولي",
                students: "الطلاب",
                attendance: "الحضور",
                assessments: "التقييمات",
                memorization: "الحفظ",
                signOut: "تسجيل الخروج",
                dashboardOverview: "نظرة عامة على لوحة التحكم",
                totalClasses: "إجمالي الفصول",
                totalStudents: "إجمالي الطلاب",
                attendanceToday: "الحضور اليوم",
                averageGrade: "متوسط الدرجات",
                className: "اسم الفصل",
                level: "المستوى",
                students: "الطلاب",
                actions: "الإجراءات",
                name: "الاسم",
                gender: "الجنس",
                selectClass: "اختر الفصل",
                selectSubject: "اختر المادة",
                selectScheme: "اختر جدول الحفظ",
                selectDay: "اختر اليوم",
                studentName: "اسم الطالب",
                status: "الحالة",
                ca1: "التقييم الأول",
                ca2: "التقييم الثاني",
                ca3: "التقييم الثالث",
                exam: "الامتحان",
                comments: "التعليقات",
                week: "الأسبوع",
                day: "اليوم",
                fromAyah: "من الآية",
                toAyah: "إلى الآية",
                dailyGrade: "الدرجة اليومية",
                examGrade: "درجة الامتحان",
                saveAttendance: "حفظ الحضور",
                saveAssessments: "حفظ التقييمات",
                saveProgress: "حفظ التقدم",
                close: "إغلاق",
                view: "عرض",
                errors: {
                    unauthorized: "غير مخول. يرجى تسجيل الدخول مرة أخرى.",
                    serverError: "فشل الاتصال بالخادم.",
                    fetchError: "فشل جلب البيانات.",
                    saveError: "فشل حفظ البيانات.",
                    logoutError: "فشل تسجيل الخروج.",
                    notFormMaster: "أنت لست المشرف على هذا الفصل."
                }
            }
        };

        let currentLang = localStorage.getItem("lang") || "en";
        let staffId = null; // Store numeric staff ID
        let isFormMaster = false;
        let formMasterClass = null; // { section_id, class_id }
        const API_BASE_URL = "/api"; // Adjust if needed

        async function fetchData(endpoint, method = "GET", body = null) {
            const url = `${API_BASE_URL}${endpoint}`;
            const options = {
                method,
                headers: { "Content-Type": "application/json" },
                credentials: "include"
            };
            if (body) options.body = JSON.stringify(body);
            try {
                const response = await fetch(url, options);
                if (response.status === 401) {
                    throw new Error("UNAUTHORIZED");
                }
                if (response.status === 500) {
                    throw new Error("SERVER_ERROR");
                }
                return await response.json();
            } catch (error) {
                console.error("Fetch Error:", error);
                if (error.message === "UNAUTHORIZED") {
                    showMessageModal(translations[currentLang].errors.unauthorized, translations[currentLang].errors.unauthorized);
                    setTimeout(() => window.location.href = '/staff-login', 2000);
                } else if (error.message === "SERVER_ERROR") {
                    showMessageModal("Server Error", translations[currentLang].errors.serverError);
                } else {
                    showMessageModal("Error", translations[currentLang].errors.fetchError);
                }
                throw error;
            }
        }

        function translatePage(lang) {
            document.querySelectorAll("[data-translate]").forEach((el) => {
                const key = el.getAttribute("data-translate");
                const keys = key.split(".");
                let value = translations[lang];
                keys.forEach((k) => (value = value?.[k]));
                if (value) {
                    if (el.tagName === "TITLE") {
                        el.textContent = value;
                    } else {
                        el.textContent = value;
                    }
                }
            });
            document.documentElement.setAttribute("dir", lang === "ar" ? "rtl" : "ltr");
            localStorage.setItem("lang", lang);
        }

        function showMessageModal(title, message) {
            const modalTitle = document.getElementById("messageModalLabel");
            const modalText = document.getElementById("messageText");
            const messageModalElement = document.getElementById("messageModal");
            if (modalTitle && modalText && messageModalElement) {
                modalTitle.textContent = title;
                modalText.textContent = message;
                const modal = new bootstrap.Modal(messageModalElement);
                modal.show();
            } else {
                alert(`${title}: ${message}`);
            }
        }

        async function fetchStaffInfo() {
            try {
                const response = await fetchData(`/staff/${staffId}`);
                if (response.success) {
                    const staff = response.data;
                    document.getElementById('userRole').textContent = staff.role || 'N/A';
                    document.getElementById('userName').textContent = staff.staff_id || 'N/A';
                    isFormMaster = !!staff.formMaster;
                    formMasterClass = staff.formMaster ? {
                        section_id: staff.formMaster.section_id,
                        class_id: staff.formMaster.class_id
                    } : null;
                    if (isFormMaster) {
                        document.getElementById('attendanceNav').style.display = 'block';
                        document.getElementById('attendance').style.display = 'block';
                    }
                } else {
                    showMessageModal('Error', response.message || translations[currentLang].errors.fetchError);
                }
            } catch (error) {
                // Handled in fetchData
            }
        }

        async function fetchDashboardStats() {
            try {
                const response = await fetchData(`/staff-dashboard-stats/${staffId}`);
                if (response.success) {
                    document.getElementById('totalClasses').textContent = response.data.totalClasses || 0;
                    document.getElementById('totalStudents').textContent = response.data.totalStudents || 0;
                    document.getElementById('attendanceToday').textContent = (response.data.attendanceToday || 0) + '%';
                    document.getElementById('averageGrade').textContent = response.data.averageGrade || 0;
                } else {
                    showMessageModal('Error', response.message || translations[currentLang].errors.fetchError);
                }
            } catch (error) {
                // Handled in fetchData
            }
        }

        async function fetchClasses() {
            try {
                const response = await fetchData(`/staff/${staffId}`);
                if (response.success) {
                    const classes = response.data.classes || [];
                    const classesTableBody = document.getElementById('classesTableBody');
                    const classSelect = document.getElementById('classSelect');
                    const assessmentClassSelect = document.getElementById('assessmentClassSelect');
                    const memorizationClassSelect = document.getElementById('memorizationClassSelect');
                    classSelect.innerHTML = '<option value="" data-translate="selectClass">Select Class</option>';
                    assessmentClassSelect.innerHTML = '<option value="" data-translate="selectClass">Select Class</option>';
                    memorizationClassSelect.innerHTML = '<option value="" data-translate="selectClass">Select Class</option>';
                    classesTableBody.innerHTML = '';

                    const classDetails = await fetchData('/classes');
                    if (!classDetails.success) {
                        throw new Error('Failed to fetch class details');
                    }

                    classes.forEach(cls => {
                        const classInfo = classDetails.data.find(c => 
                            c.section_id === cls.section_id && 
                            (cls.section_id === 1 ? c.class_id === cls.class_id : c.western_class_id === cls.class_id)
                        );
                        if (!classInfo) return;

                        const row = classesTableBody.insertRow();
                        row.insertCell().textContent = classInfo.class_name;
                        row.insertCell().textContent = classInfo.level || 'N/A';
                        row.insertCell().textContent = classInfo.student_count || 0;
                        const actionsCell = row.insertCell();
                        actionsCell.innerHTML = `
                            <button class="btn btn-sm btn-primary-custom" onclick="viewClassDetails(${cls.section_id}, ${cls.class_id})" data-translate="view">View</button>
                        `;
                        const option = document.createElement('option');
                        option.value = `${cls.section_id}:${cls.class_id}`;
                        option.textContent = classInfo.class_name;
                        classSelect.appendChild(option.cloneNode(true));
                        assessmentClassSelect.appendChild(option.cloneNode(true));
                        if (cls.section_id === 1) { // Only Islamic classes for memorization
                            memorizationClassSelect.appendChild(option.cloneNode(true));
                        }
                    });
                    translatePage(currentLang);
                } else {
                    showMessageModal('Error', response.message || translations[currentLang].errors.fetchError);
                }
            } catch (error) {
                // Handled in fetchData
            }
        }

        async function fetchStudents(sectionId, classId) {
            try {
                const response = await fetchData(`/staff-students/${staffId}?section_id=${sectionId}&class_id=${classId}`);
                if (response.success) {
                    const students = response.data;
                    const studentsTableBody = document.getElementById('studentsTableBody');
                    studentsTableBody.innerHTML = '';
                    students.forEach(student => {
                        const row = studentsTableBody.insertRow();
                        row.insertCell().textContent = student.full_name;
                        row.insertCell().textContent = student.gender;
                        const actionsCell = row.insertCell();
                        actionsCell.innerHTML = `
                            <button class="btn btn-sm btn-primary-custom" onclick="viewStudentDetails(${student.student_id})" data-translate="view">View</button>
                        `;
                    });
                    translatePage(currentLang);
                } else {
                    showMessageModal('Error', response.message || translations[currentLang].errors.fetchError);
                }
            } catch (error) {
                // Handled in fetchData
            }
        }

        async function fetchAttendance(sectionId, classId, date, day) {
            if (!isFormMaster || (formMasterClass.section_id !== parseInt(sectionId) || formMasterClass.class_id !== parseInt(classId))) {
                showMessageModal('Error', translations[currentLang].errors.notFormMaster);
                return;
            }
            try {
                const response = await fetchData(`/staff-attendance/${staffId}?section_id=${sectionId}&class_id=${classId}&date=${date}&day=${day}`);
                if (response.success) {
                    const attendance = response.data;
                    const attendanceTableBody = document.getElementById('attendanceTableBody');
                    attendanceTableBody.innerHTML = '';
                    attendance.forEach(record => {
                        const row = attendanceTableBody.insertRow();
                        row.insertCell().textContent = record.student_name;
                        const statusCell = row.insertCell();
                        statusCell.innerHTML = `
                            <select class="form-select" data-enrollment-id="${record.enrollment_id}">
                                <option value="Present" ${record.attendance_status === 'Present' ? 'selected' : ''}>Present</option>
                                <option value="Absent" ${record.attendance_status === 'Absent' ? 'selected' : ''}>Absent</option>
                            </select>
                        `;
                    });
                    translatePage(currentLang);
                } else {
                    showMessageModal('Error', response.message || translations[currentLang].errors.fetchError);
                }
            } catch (error) {
                // Handled in fetchData
            }
        }

        async function fetchAssessments(sectionId, classId, subjectId) {
            try {
                const response = await fetchData(`/staff-assessments/${staffId}?section_id=${sectionId}&class_id=${classId}&subject_id=${subjectId}`);
                if (response.success) {
                    const assessments = response.data;
                    const assessmentsTableBody = document.getElementById('assessmentsTableBody');
                    assessmentsTableBody.innerHTML = '';
                    assessments.forEach(record => {
                        const row = assessmentsTableBody.insertRow();
                        row.insertCell().textContent = record.student_name;
                        row.insertCell().innerHTML = `<input type="number" class="form-control" data-enrollment-id="${record.enrollment_id}" data-field="ca1_score" value="${record.ca1_score || ''}" min="0" max="100">`;
                        row.insertCell().innerHTML = `<input type="number" class="form-control" data-enrollment-id="${record.enrollment_id}" data-field="ca2_score" value="${record.ca2_score || ''}" min="0" max="100">`;
                        row.insertCell().innerHTML = `<input type="number" class="form-control" data-enrollment-id="${record.enrollment_id}" data-field="ca3_score" value="${record.ca3_score || ''}" min="0" max="100">`;
                        row.insertCell().innerHTML = `<input type="number" class="form-control" data-enrollment-id="${record.enrollment_id}" data-field="exam_score" value="${record.exam_score || ''}" min="0" max="100">`;
                        row.insertCell().innerHTML = `<input type="text" class="form-control" data-enrollment-id="${record.enrollment_id}" data-field="comments" value="${record.comments || ''}">`;
                    });
                    translatePage(currentLang);
                } else {
                    showMessageModal('Error', response.message || translations[currentLang].errors.fetchError);
                }
            } catch (error) {
                // Handled in fetchData
            }
        }

        async function fetchMemorization(sectionId, classId, schemeId) {
            try {
                const response = await fetchData(`/staff-memorization/${staffId}?section_id=${sectionId}&class_id=${classId}&scheme_id=${schemeId}`);
                if (response.success) {
                    const memorization = response.data;
                    const memorizationTableBody = document.getElementById('memorizationTableBody');
                    memorizationTableBody.innerHTML = '';
                    memorization.forEach(record => {
                        const row = memorizationTableBody.insertRow();
                        row.insertCell().textContent = record.student_name;
                        row.insertCell().textContent = record.week;
                        row.insertCell().textContent = record.day;
                        row.insertCell().textContent = record.from_surah_ayah;
                        row.insertCell().textContent = record.to_surah_ayah;
                        row.insertCell().innerHTML = `
                            <select class="form-select" data-enrollment-id="${record.enrollment_id}" data-field="daily_grade">
                                <option value="" ${!record.daily_grade ? 'selected' : ''}></option>
                                <option value="A" ${record.daily_grade === 'A' ? 'selected' : ''}>A</option>
                                <option value="B" ${record.daily_grade === 'B' ? 'selected' : ''}>B</option>
                                <option value="C" ${record.daily_grade === 'C' ? 'selected' : ''}>C</option>
                                <option value="D" ${record.daily_grade === 'D' ? 'selected' : ''}>D</option>
                                <option value="E" ${record.daily_grade === 'E' ? 'selected' : ''}>E</option>
                                <option value="F" ${record.daily_grade === 'F' ? 'selected' : ''}>F</option>
                            </select>
                        `;
                        row.insertCell().innerHTML = `<input type="number" class="form-control" data-enrollment-id="${record.enrollment_id}" data-field="exam_grade" value="${record.exam_grade || ''}" min="0" max="100">`;
                        row.insertCell().innerHTML = `<input type="text" class="form-control" data-enrollment-id="${record.enrollment_id}" data-field="comments" value="${record.comments || ''}">`;
                    });
                    translatePage(currentLang);
                } else {
                    showMessageModal('Error', response.message || translations[currentLang].errors.fetchError);
                }
            } catch (error) {
                // Handled in fetchData
            }
        }

        async function fetchSubjects(sectionId, classId) {
            try {
                const response = await fetchData(`/staff-subjects/${staffId}?section_id=${sectionId}&class_id=${classId}`);
                if (response.success) {
                    const subjects = response.data;
                    const assessmentSubjectSelect = document.getElementById('assessmentSubjectSelect');
                    assessmentSubjectSelect.innerHTML = '<option value="" data-translate="selectSubject">Select Subject</option>';
                    subjects.forEach(subject => {
                        const option = document.createElement('option');
                        option.value = subject.subject_id;
                        option.textContent = subject.subject_name;
                        assessmentSubjectSelect.appendChild(option);
                    });
                    translatePage(currentLang);
                } else {
                    showMessageModal('Error', response.message || translations[currentLang].errors.fetchError);
                }
            } catch (error) {
                // Handled in fetchData
            }
        }

        async function fetchMemorizationSchemes(classId) {
            try {
                const response = await fetchData(`/staff-memorization-schemes?class_id=${classId}`);
                if (response.success) {
                    const schemes = response.data;
                    const memorizationSchemeSelect = document.getElementById('memorizationSchemeSelect');
                    memorizationSchemeSelect.innerHTML = '<option value="" data-translate="selectScheme">Select Memorization Scheme</option>';
                    schemes.forEach(scheme => {
                        const option = document.createElement('option');
                        option.value = scheme.id;
                        option.textContent = `Week ${scheme.week} - ${scheme.day} (${scheme.from_surah_ayah} to ${scheme.to_surah_ayah})`;
                        memorizationSchemeSelect.appendChild(option);
                    });
                    translatePage(currentLang);
                } else {
                    showMessageModal('Error', response.message || translations[currentLang].errors.fetchError);
                }
            } catch (error) {
                // Handled in fetchData
            }
        }

        async function saveAttendance() {
            const attendanceTableBody = document.getElementById('attendanceTableBody');
            const date = document.getElementById('attendanceDate').value;
            const day = document.getElementById('attendanceDay').value;
            if (!isFormMaster || !formMasterClass) {
                showMessageModal('Error', translations[currentLang].errors.notFormMaster);
                return;
            }
            if (!date || !day) {
                showMessageModal('Error', 'Please select both date and day.');
                return;
            }
            const attendanceData = [];
            attendanceTableBody.querySelectorAll('select').forEach(select => {
                attendanceData.push({
                    enrollment_id: select.getAttribute('data-enrollment-id'),
                    attendance_status: select.value,
                    date,
                    day
                });
            });
            try {
                const response = await fetchData(`/staff-attendance/${staffId}`, 'POST', { 
                    section_id: formMasterClass.section_id, 
                    class_id: formMasterClass.class_id, 
                    date, 
                    day,
                    attendance: attendanceData 
                });
                if (response.success) {
                    showMessageModal('Success', 'Attendance saved successfully.');
                } else {
                    showMessageModal('Error', response.message || translations[currentLang].errors.saveError);
                }
            } catch (error) {
                // Handled in fetchData
            }
        }

        async function saveAssessments() {
            const assessmentsTableBody = document.getElementById('assessmentsTableBody');
            const sectionId = document.getElementById('assessmentClassSelect').value.split(':')[0];
            const classId = document.getElementById('assessmentClassSelect').value.split(':')[1];
            const subjectId = document.getElementById('assessmentSubjectSelect').value;
            const term = 1; // Default term
            const assessmentsData = [];
            assessmentsTableBody.querySelectorAll('tr').forEach(row => {
                const enrollmentId = row.querySelector('input[data-field="ca1_score"]').getAttribute('data-enrollment-id');
                assessmentsData.push({
                    enrollment_id: enrollmentId,
                    ca1_score: row.querySelector('input[data-field="ca1_score"]').value || null,
                    ca2_score: row.querySelector('input[data-field="ca2_score"]').value || null,
                    ca3_score: row.querySelector('input[data-field="ca3_score"]').value || null,
                    exam_score: row.querySelector('input[data-field="exam_score"]').value || null,
                    comments: row.querySelector('input[data-field="comments"]').value || '',
                    date: new Date().toISOString().split('T')[0]
                });
            });
            try {
                const response = await fetchData(`/staff-assessments/${staffId}`, 'POST', { 
                    section_id: sectionId, 
                    class_id: classId, 
                    subject_id: subjectId, 
                    term,
                    assessments: assessmentsData 
                });
                if (response.success) {
                    showMessageModal('Success', 'Assessments saved successfully.');
                } else {
                    showMessageModal('Error', response.message || translations[currentLang].errors.saveError);
                }
            } catch (error) {
                // Handled in fetchData
            }
        }

        async function saveMemorization() {
            const memorizationTableBody = document.getElementById('memorizationTableBody');
            const sectionId = document.getElementById('memorizationClassSelect').value.split(':')[0];
            const classId = document.getElementById('memorizationClassSelect').value.split(':')[1];
            const schemeId = document.getElementById('memorizationSchemeSelect').value;
            const memorizationData = [];
            memorizationTableBody.querySelectorAll('tr').forEach(row => {
                const enrollmentId = row.querySelector('select[data-field="daily_grade"]').getAttribute('data-enrollment-id');
                memorizationData.push({
                    enrollment_id: enrollmentId,
                    scheme_id: schemeId,
                    daily_grade: row.querySelector('select[data-field="daily_grade"]').value || null,
                    exam_grade: row.querySelector('input[data-field="exam_grade"]').value || null,
                    comments: row.querySelector('input[data-field="comments"]').value || '',
                    date: new Date().toISOString().split('T')[0]
                });
            });
            try {
                const response = await fetchData(`/staff-memorization/${staffId}`, 'POST', { 
                    section_id: sectionId, 
                    class_id: classId, 
                    scheme_id: schemeId,
                    memorization: memorizationData 
                });
                if (response.success) {
                    showMessageModal('Success', 'Memorization progress saved successfully.');
                } else {
                    showMessageModal('Error', response.message || translations[currentLang].errors.saveError);
                }
            } catch (error) {
                // Handled in fetchData
            }
        }

        function viewClassDetails(sectionId, classId) {
            showMessageModal('Info', `Viewing details for class (Section: ${sectionId}, ID: ${classId})`);
        }

        function viewStudentDetails(studentId) {
            showMessageModal('Info', `Viewing details for student ID: ${studentId}`);
        }

        async function fetchStaffIdFromSession() {
            try {
                const response = await fetchData('/staff-session');
                if (response.success) {
                    staffId = response.data.staff_id;
                    return staffId;
                } else {
                    throw new Error('Failed to fetch staff ID');
                }
            } catch (error) {
                showMessageModal('Error', translations[currentLang].errors.unauthorized);
                setTimeout(() => window.location.href = '/staff-login', 2000);
                throw error;
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await fetchStaffIdFromSession();
                translatePage(currentLang);
                await fetchStaffInfo();
                await fetchDashboardStats();
                await fetchClasses();

                const langToggleBtn = document.getElementById('langToggle');
                if (langToggleBtn) {
                    langToggleBtn.addEventListener('click', () => {
                        currentLang = currentLang === 'en' ? 'ar' : 'en';
                        translatePage(currentLang);
                    });
                }

                const classSelect = document.getElementById('classSelect');
                classSelect.addEventListener('change', () => {
                    const [sectionId, classId] = classSelect.value.split(':').map(Number);
                    if (sectionId && classId) {
                        fetchStudents(sectionId, classId);
                    }
                });

                const attendanceDate = document.getElementById('attendanceDate');
                const attendanceDay = document.getElementById('attendanceDay');
                attendanceDate.addEventListener('change', () => {
                    if (isFormMaster && formMasterClass && attendanceDay.value) {
                        fetchAttendance(formMasterClass.section_id, formMasterClass.class_id, attendanceDate.value, attendanceDay.value);
                    }
                });
                attendanceDay.addEventListener('change', () => {
                    if (isFormMaster && formMasterClass && attendanceDate.value) {
                        fetchAttendance(formMasterClass.section_id, formMasterClass.class_id, attendanceDate.value, attendanceDay.value);
                    }
                });

                const assessmentClassSelect = document.getElementById('assessmentClassSelect');
                const assessmentSubjectSelect = document.getElementById('assessmentSubjectSelect');
                assessmentClassSelect.addEventListener('change', () => {
                    const [sectionId, classId] = assessmentClassSelect.value.split(':').map(Number);
                    if (sectionId && classId) {
                        fetchSubjects(sectionId, classId);
                    }
                });
                assessmentSubjectSelect.addEventListener('change', () => {
                    const [sectionId, classId] = assessmentClassSelect.value.split(':').map(Number);
                    const subjectId = assessmentSubjectSelect.value;
                    if (sectionId && classId && subjectId) {
                        fetchAssessments(sectionId, classId, subjectId);
                    }
                });

                const memorizationClassSelect = document.getElementById('memorizationClassSelect');
                const memorizationSchemeSelect = document.getElementById('memorizationSchemeSelect');
                memorizationClassSelect.addEventListener('change', () => {
                    const [sectionId, classId] = memorizationClassSelect.value.split(':').map(Number);
                    if (sectionId === 1 && classId) {
                        fetchMemorizationSchemes(classId);
                    }
                });
                memorizationSchemeSelect.addEventListener('change', () => {
                    const [sectionId, classId] = memorizationClassSelect.value.split(':').map(Number);
                    const schemeId = memorizationSchemeSelect.value;
                    if (sectionId === 1 && classId && schemeId) {
                        fetchMemorization(sectionId, classId, schemeId);
                    }
                });
            } catch (error) {
                // Handled in fetchStaffIdFromSession
            }
        });

        async function signOut() {
            try {
                const response = await fetchData('/staff-logout', 'POST', {});
                if (response.success) {
                    window.location.href = '/staff-login';
                } else {
                    showMessageModal('Error', response.message || translations[currentLang].errors.logoutError);
                }
            } catch (error) {
                // Handled in fetchData
            }
        }
    </script>
</body>
</html>