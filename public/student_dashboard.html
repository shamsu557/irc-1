<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="studentDashboard">Student Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Amiri:wght@400;700&display=swap');
        :root {
            --primary-color: #00897b;
            --secondary-color: #2f4f4f;
            --light-color: #f0f8f0;
            --white-color: #ffffff;
            --card-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--light-color);
            color: var(--secondary-color);
            min-height: 100vh;
        }
        .text-arabic {
            font-family: 'Amiri', serif;
        }
        .navbar-custom {
            background-color: var(--white-color);
            padding: 1rem 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .navbar-custom .navbar-brand {
            color: var(--secondary-color);
        }
        .brand-text {
            color: var(--secondary-color) !important;
            font-size: 1rem;
        }
        .dashboard-container {
            max-width: 1400px;
            margin: 2rem auto;
            background-color: var(--white-color);
            border-radius: 1.5rem;
            box-shadow: var(--card-shadow);
            padding: 2rem;
            transition: transform 0.3s ease-in-out;
        }
        .dashboard-container:hover {
            transform: translateY(-3px);
        }
        .profile-card {
            background: linear-gradient(135deg, var(--primary-color) 0%, #00695c 100%);
            color: var(--white-color);
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .profile-img {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border: 4px solid var(--white-color);
            border-radius: 50%;
        }
        .info-card {
            background-color: var(--white-color);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }
        .btn-primary-custom {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: var(--white-color);
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .btn-primary-custom:hover {
            background-color: #00695c;
            border-color: #00695c;
            transform: translateY(-2px);
        }
        .btn-lang-toggle {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
            color: var(--white-color);
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .btn-lang-toggle:hover {
            background-color: #1a2f2f;
            border-color: #1a2f2f;
            color: var(--white-color);
            transform: translateY(-2px);
        }
        .alert-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1050;
        }
        .modal-header {
            border-bottom: none;
        }
        .custom-badge {
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
            border-radius: 1rem;
            display: inline-block;
            margin: 0.25rem;
        }
        .custom-badge-primary {
            background-color: var(--primary-color);
            color: var(--white-color);
        }
        .custom-badge-secondary {
            background-color: var(--secondary-color);
            color: var(--white-color);
        }
        @media (max-width: 768px) {
            .dashboard-container {
                margin: 1rem;
                padding: 1.5rem;
            }
            .profile-img {
                width: 100px;
                height: 100px;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-custom">
        <div class="container">
            <a class="navbar-brand fw-bold brand-text mx-auto mx-lg-0" href="/">
                <i class="fas fa-graduation-cap me-2 text-[var(--primary-color)]"></i> IRC
            </a>
            <div class="ms-auto d-flex gap-2">
                <button id="langToggle" class="btn btn-lang-toggle rounded-pill px-4 py-2 shadow-sm text-white" data-translate="toggleLanguage">العربية</button>
                <button id="logoutBtn" class="btn btn-primary-custom rounded-pill px-4 py-2" data-translate="logout">Logout</button>
            </div>
        </div>
    </nav>

    <div class="alert-container"></div>

    <div class="dashboard-container container">
        <div class="profile-card text-center">
            <img id="profilePicture" src="Uploads/default.jpg" alt="Profile Picture" class="profile-img mb-3">
            <h2 id="studentName" class="fw-bold mb-2"></h2>
            <p id="studentId" class="mb-0 text-lg"></p>
        </div>

        <div class="row g-4">
            <div class="col-lg-6">
                <div class="info-card">
                    <h3 class="fw-bold mb-4" data-translate="personalInfo">Personal Information</h3>
                    <p><strong data-translate="studentIdLabel">Student ID:</strong> <span id="studentIdDisplay"></span></p>
                    <p><strong data-translate="gender">Gender:</strong> <span id="gender"></span></p>
                    <p><strong data-translate="dateOfBirth">Date of Birth:</strong> <span id="dateOfBirth"></span></p>
                    <p><strong data-translate="email">Email:</strong> <span id="email"></span></p>
                    <p><strong data-translate="phone">Phone:</strong> <span id="guardianPhone"></span></p>
                    <p><strong data-translate="address">Address:</strong> <span id="address"></span></p>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="info-card">
                    <h3 class="fw-bold mb-4" data-translate="academicInfo">Academic Information</h3>
                    <p><strong data-translate="classes">Classes:</strong></p>
                    <div id="classes" class="d-flex flex-wrap gap-2 mb-3"></div>
                    <p><strong data-translate="subjects">Subjects:</strong></p>
                    <div id="subjects" class="d-flex flex-wrap gap-2"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="messageModal" tabindex="-1" aria-labelledby="messageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-xl shadow-2xl">
                <div class="modal-header">
                    <h5 class="modal-title font-bold text-gray-800" id="messageModalLabel">Message</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-6">
                    <p id="messageText" class="text-gray-700"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal" data-translate="close">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const translations = {
            en: {
                studentDashboard: "Student Dashboard",
                toggleLanguage: "العربية",
                logout: "Logout",
                personalInfo: "Personal Information",
                academicInfo: "Academic Information",
                studentIdLabel: "Student ID",
                gender: "Gender",
                dateOfBirth: "Date of Birth",
                email: "Email",
                phone: "Phone",
                address: "Address",
                classes: "Classes",
                subjects: "Subjects",
                close: "Close",
                errors: {
                    unauthorized: "You are not authorized. Please log in again.",
                    serverError: "Failed to connect to the server.",
                    fetchError: "Failed to fetch student details.",
                    logoutError: "Logout failed."
                }
            },
            ar: {
                studentDashboard: "لوحة تحكم الطالب",
                toggleLanguage: "English",
                logout: "تسجيل الخروج",
                personalInfo: "المعلومات الشخصية",
                academicInfo: "المعلومات الأكاديمية",
                studentIdLabel: "معرف الطالب",
                gender: "الجنس",
                dateOfBirth: "تاريخ الميلاد",
                email: "البريد الإلكتروني",
                phone: "الهاتف",
                address: "العنوان",
                classes: "الفصول",
                subjects: "المواد",
                close: "إغلاق",
                errors: {
                    unauthorized: "غير مخول. يرجى تسجيل الدخول مرة أخرى.",
                    serverError: "فشل الاتصال بالخادم.",
                    fetchError: "فشل جلب تفاصيل الطالب.",
                    logoutError: "فشل تسجيل الخروج."
                }
            }
        };

        let currentLang = localStorage.getItem("lang") || "en";
        const API_BASE_URL = "http://localhost:5000/api";

        async function fetchData(endpoint, method = "GET", body = null) {
            const url = `${API_BASE_URL}${endpoint}`;
            const options = {
                method,
                headers: { "Content-Type": "application/json" },
                credentials: "include"
            };
            if (body) options.body = JSON.stringify(body);
            try {
                const response = await fetch(url, options);
                if (response.status === 401) {
                    throw new Error("UNAUTHORIZED");
                }
                if (response.status === 500) {
                    throw new Error("SERVER_ERROR");
                }
                return await response.json();
            } catch (error) {
                console.error("Fetch Error:", error);
                if (error.message === "UNAUTHORIZED") {
                    showMessageModal(translations[currentLang].errors.unauthorized, translations[currentLang].errors.unauthorized);
                    setTimeout(() => window.location.href = '/student-login', 2000);
                } else if (error.message === "SERVER_ERROR") {
                    showMessageModal("Server Error", translations[currentLang].errors.serverError);
                } else {
                    showMessageModal("Error", translations[currentLang].errors.serverError);
                }
                throw error;
            }
        }

        function translatePage(lang) {
            document.querySelectorAll("[data-translate]").forEach((el) => {
                const key = el.getAttribute("data-translate");
                const keys = key.split(".");
                let value = translations[lang];
                keys.forEach((k) => (value = value?.[k]));
                if (value) {
                    if (el.tagName === "TITLE") {
                        el.textContent = value;
                    } else {
                        el.textContent = value;
                    }
                }
            });
            document.documentElement.setAttribute("dir", lang === "ar" ? "rtl" : "ltr");
            localStorage.setItem("lang", lang);
        }

        function showMessageModal(title, message) {
            const modalTitle = document.getElementById("messageModalLabel");
            const modalText = document.getElementById("messageText");
            const messageModalElement = document.getElementById("messageModal");
            if (modalTitle && modalText && messageModalElement) {
                modalTitle.textContent = title;
                modalText.textContent = message;
                const modal = new bootstrap.Modal(messageModalElement);
                modal.show();
            } else {
                alert(`${title}: ${message}`);
            }
        }

        async function fetchStudentDetails() {
            try {
                const response = await fetchData('/student-details');
                console.log('API Response:', response); // Debug
                if (response.success) {
                    const student = response.data;
                    console.log('Student Data:', student); // Debug
                    document.getElementById('studentName').textContent = student.name || 'N/A';
                    document.getElementById('studentId').textContent = student.student_id || 'N/A';
                    document.getElementById('studentIdDisplay').textContent = student.student_id || 'N/A';
                    document.getElementById('profilePicture').src = student.profile_picture || 'Uploads/default.jpg';
                    document.getElementById('gender').textContent = student.gender || 'N/A';
                    document.getElementById('dateOfBirth').textContent = student.date_of_birth || 'N/A';
                    document.getElementById('email').textContent = student.email || 'N/A';
                    document.getElementById('guardianPhone').textContent = student.guardian_phone || 'N/A';
                    document.getElementById('address').textContent = student.address || 'N/A';

                    const classesContainer = document.getElementById('classes');
                    classesContainer.innerHTML = '';
                    console.log('Rendering classes:', student.classes); // Debug
                    if (student.classes && student.classes.length > 0) {
                        student.classes.forEach(cls => {
                            const badge = document.createElement('span');
                            badge.className = 'custom-badge custom-badge-primary';
                            badge.textContent = cls;
                            classesContainer.appendChild(badge);
                        });
                    } else {
                        classesContainer.innerHTML = '<span class="text-muted">No classes assigned</span>';
                    }

                    const subjectsContainer = document.getElementById('subjects');
                    subjectsContainer.innerHTML = '';
                    console.log('Rendering subjects:', student.subjects); // Debug
                    if (student.subjects && student.subjects.length > 0) {
                        student.subjects.forEach(sub => {
                            const badge = document.createElement('span');
                            badge.className = 'custom-badge custom-badge-secondary';
                            badge.textContent = sub;
                            subjectsContainer.appendChild(badge);
                        });
                    } else {
                        subjectsContainer.innerHTML = '<span class="text-muted">No subjects assigned</span>';
                    }
                } else {
                    showMessageModal('Error', response.message || translations[currentLang].errors.fetchError);
                }
            } catch (error) {
                // Error handling is already done in fetchData
            }
        }

        async function logout() {
            try {
                const response = await fetchData('/student-logout', 'POST');
                if (response.success) {
                    window.location.href = '/student-login';
                } else {
                    showMessageModal('Error', response.message || translations[currentLang].errors.logoutError);
                }
            } catch (error) {
                showMessageModal('Error', translations[currentLang].errors.serverError);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            translatePage(currentLang);
            fetchStudentDetails();

            const langToggleBtn = document.getElementById('langToggle');
            if (langToggleBtn) {
                langToggleBtn.addEventListener('click', () => {
                    currentLang = currentLang === 'en' ? 'ar' : 'en';
                    translatePage(currentLang);
                });
            }

            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', logout);
            }
        });
    </script>
</body>
</html>