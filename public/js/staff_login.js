const translations = {
    en: {
        loginTitle: "Staff Login",
        staffId: "Staff ID",
        password: "Password",
        updateCreds: "Update Credentials",
        newPassword: "New Password",
        confirmPassword: "Confirm Password",
        submit: "Submit",
        back: "Back",
        forgotPassword: "Forgot Password?",
        securityQuestion: "Security Question",
        securityAnswer: "Security Answer",
        resetPasswordTitle: "Reset Password",
        resetPasswordBtn: "Reset Password",
        newPasswordLabel: "New Password (min 6 chars)",
        newPasswordPrompt: "Enter your new password.",
        answerQuestion: "Answer your security question to continue.",
        verify: "Verify Answer",
        toggleLanguage: "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©",
        backToHome: "Back to Home",
        secureAccess: "Secure access to the Ibadurrahman College Staff system.",
        secure: "Secure",
        control: "Control",
        analytics: "Analytics",
        staffLogin: "Staff Login",
        signInDesc: "Sign in to access the staff dashboard.",
        allFieldsRequired: "All fields are required.",
        rememberMe: "Remember me",
        signIn: "Sign In",
        authorizedOnly: "Authorized personnel only",
        updateCredentials: "Update Your Credentials",
        updateCredentialsDesc: "Please update your credentials to continue.",
        newStaffIdLabel: "New Staff ID",
        nameLabel: "Full Name",
        phoneLabel: "Phone Number",
        emailLabel: "Email (Optional)",
        newSecurityQuestion: "Security Question",
        newSecurityAnswer: "Security Answer",
        updateCredentialsBtn: "Update Credentials",
        selectQuestion: "Select a security question",
        securityQuestion1: "What is your pet's name?",
        securityQuestion2: "What is your mother's maiden name?",
        securityQuestion3: "What is the name of your first school?",
        securityQuestion4: "What is your favorite book?",
        securityQuestion5: "What is the name of your hometown?",
        collegeName: "Ibadurrahman College",
        next: "Next",
        close: "Close",
        errors: {
            enterStaffId: "Please enter your Staff ID.",
            emptyAnswer: "Security answer cannot be empty.",
            passwordShort: "Password must be at least 6 characters."
        }
    },
    ar: {
        loginTitle: "ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¸Ù",
        staffId: "Ù…Ø¹Ø±Ù Ø§Ù„Ù…ÙˆØ¸Ù",
        password: "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±",
        updateCreds: "ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„",
        newPassword: "ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©",
        confirmPassword: "ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±",
        submit: "Ø¥Ø±Ø³Ø§Ù„",
        back: "Ø±Ø¬ÙˆØ¹",
        forgotPassword: "Ù‡Ù„ Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ",
        securityQuestion: "Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù†",
        securityAnswer: "Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø£Ù…Ø§Ù†",
        resetPasswordTitle: "Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±",
        resetPasswordBtn: "Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±",
        newPasswordLabel: "ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø© (6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)",
        newPasswordPrompt: "Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±Ùƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©.",
        answerQuestion: "Ø£Ø¬Ø¨ Ø¹Ù† Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù† Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©.",
        verify: "ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©",
        toggleLanguage: "English",
        backToHome: "Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©",
        secureAccess: "Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø¢Ù…Ù† Ø¥Ù„Ù‰ Ù†Ø¸Ø§Ù… Ù…ÙˆØ¸ÙÙŠ ÙƒÙ„ÙŠØ© Ø¹Ø¨Ø§Ø¯ Ø§Ù„Ø±Ø­Ù…Ù†",
        secure: "Ø¢Ù…Ù†",
        control: "Ø§Ù„ØªØ­ÙƒÙ…",
        analytics: "Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª",
        staffLogin: "ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¸Ù",
        signInDesc: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†.",
        allFieldsRequired: "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨Ø©.",
        rememberMe: "ØªØ°ÙƒØ±Ù†ÙŠ",
        signIn: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„",
        authorizedOnly: "Ù„Ù„Ø£Ø´Ø®Ø§Øµ Ø§Ù„Ù…Ø®ÙˆÙ„ÙŠÙ† ÙÙ‚Ø·",
        updateCredentials: "ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„",
        updateCredentialsDesc: "ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©.",
        newStaffIdLabel: "Ù…Ø¹Ø±Ù Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯",
        nameLabel: "Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„",
        phoneLabel: "Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ",
        emailLabel: "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)",
        newSecurityQuestion: "Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù†",
        newSecurityAnswer: "Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø£Ù…Ø§Ù†",
        updateCredentialsBtn: "ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„",
        selectQuestion: "Ø§Ø®ØªØ± Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù†",
        securityQuestion1: "Ù…Ø§ Ø§Ø³Ù… Ø­ÙŠÙˆØ§Ù†Ùƒ Ø§Ù„Ø£Ù„ÙŠÙØŸ",
        securityQuestion2: "Ù…Ø§ Ù‡Ùˆ Ø§Ø³Ù… ÙˆØ§Ù„Ø¯ØªÙƒ Ù‚Ø¨Ù„ Ø§Ù„Ø²ÙˆØ§Ø¬ØŸ",
        securityQuestion3: "Ù…Ø§ Ø§Ø³Ù… Ù…Ø¯Ø±Ø³ØªÙƒ Ø§Ù„Ø£ÙˆÙ„Ù‰ØŸ",
        securityQuestion4: "Ù…Ø§ Ù‡Ùˆ ÙƒØªØ§Ø¨Ùƒ Ø§Ù„Ù…ÙØ¶Ù„ØŸ",
        securityQuestion5: "Ù…Ø§ Ø§Ø³Ù… Ù…Ø¯ÙŠÙ†ØªÙƒ Ø§Ù„Ø£ØµÙ„ÙŠØ©ØŸ",
        collegeName: "ÙƒÙ„ÙŠØ© Ø¹Ø¨Ø§Ø¯ Ø§Ù„Ø±Ø­Ù…Ù†",
        next: "Ø§Ù„ØªØ§Ù„ÙŠ",
        close: "Ø¥ØºÙ„Ø§Ù‚",
        errors: {
            enterStaffId: "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ù…ÙˆØ¸Ù.",
            emptyAnswer: "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø¬ÙˆØ§Ø¨ Ø§Ù„Ø£Ù…Ø§Ù† ÙØ§Ø±ØºÙ‹Ø§.",
            passwordShort: "ÙŠØ¬Ø¨ Ø£Ù† ØªØªÙƒÙˆÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ù† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„."
        }
    }
};

let currentLang = localStorage.getItem("lang") || "en";

function translatePage(lang) {
    document.querySelectorAll("[data-translate]").forEach(el => {
        const key = el.getAttribute("data-translate");
        const keys = key.split(".");
        let value = translations[lang];
        keys.forEach(k => value = value?.[k]);
        if (value) {
            if (el.tagName === "INPUT" || el.tagName === "TEXTAREA") {
                el.setAttribute("placeholder", value);
            } else {
                el.textContent = value;
            }
        }
    });
    document.documentElement.setAttribute("dir", lang === "ar" ? "rtl" : "ltr");
    localStorage.setItem("lang", lang);
}

// --- UTILITY FUNCTION (Must be defined first) ---
const showMessageModal = (title, message) => {
    const modalTitle = document.getElementById('messageModalLabel');
    const modalText = document.getElementById('messageText');
    const messageModalElement = document.getElementById('messageModal');

    if (modalTitle && modalText && messageModalElement) {
        modalTitle.textContent = title;
        modalText.textContent = message;
        const modal = new bootstrap.Modal(messageModalElement);
        modal.show();
    } else {
        alert(`${title}: ${message}`);
    }
};

document.addEventListener('DOMContentLoaded', () => {
    // --- Apply translation on load ---
    translatePage(currentLang);
    const langToggleBtn = document.getElementById("langToggle");
    if (langToggleBtn) {
        langToggleBtn.addEventListener("click", () => {
            currentLang = currentLang === "en" ? "ar" : "en";
            translatePage(currentLang);
        });
    }

    // --- LOGIN & UPDATE ELEMENTS ---
    const staffLoginForm = document.getElementById('staffLoginForm');
    const loginFormSection = document.getElementById('loginFormSection');
    const updateCredentialsSection = document.getElementById('updateCredentialsSection');
    const updateCredentialsForm = document.getElementById('updateCredentialsForm');
    const staffIdInput = document.getElementById('staffId');
    const passwordInput = document.getElementById('password');
    const originalStaffIdInput = document.getElementById('originalStaffId');

    // --- FORGOT PASSWORD ELEMENTS ---
    const forgotPasswordModal = document.getElementById('forgotPasswordModal');
    const forgotStep1 = document.getElementById('forgotStep1');
    const forgotStep2 = document.getElementById('forgotStep2');
    const forgotStep3 = document.getElementById('forgotStep3');
    const forgotStaffIdInput = document.getElementById('forgotStaffId');
    const forgotNextBtn = document.getElementById('forgotNextBtn');
    
    let currentForgotStaffId = ''; 

    // --- LOGIN FORM SUBMISSION ---
    if (staffLoginForm) {
        staffLoginForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            if (!staffLoginForm.checkValidity()) {
                staffLoginForm.classList.add('was-validated');
                return;
            }

            const staffId = staffIdInput.value;
            const password = passwordInput.value;

            try {
                const response = await fetch('/api/staff-login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ staffId, password })
                });
                const result = await response.json();

                if (result.success) {
                    if (result.message.includes('First-time login')) {
                        loginFormSection.classList.add('d-none');
                        updateCredentialsSection.classList.remove('d-none');
                        originalStaffIdInput.value = staffId;
                        document.getElementById('newStaffId').value = staffId; 
                        showMessageModal('âš ï¸', result.message);
                    } else {
                        window.location.href = result.redirect;
                    }
                } else {
                    showMessageModal('âŒ', result.message);
                }
            } catch (error) {
                showMessageModal('ðŸ›‘', 'Server connection failed.');
            }
        });
    }

    // --- UPDATE CREDENTIALS FORM ---
    if (updateCredentialsForm) {
        updateCredentialsForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            if (!updateCredentialsForm.checkValidity()) {
                updateCredentialsForm.classList.add('was-validated');
                return;
            }

            const formData = {
                staffId: originalStaffIdInput.value,
                newStaffId: document.getElementById('newStaffId').value,
                newName: document.getElementById('newName').value,
                newPhone: document.getElementById('newPhone').value,
                newEmail: document.getElementById('newEmail').value,
                newPassword: document.getElementById('newPasswordInput').value,
                securityQuestion: document.getElementById('newSecurityQuestion').value,
                securityAnswer: document.getElementById('newSecurityAnswerInput').value,
            };

            try {
                const response = await fetch('/api/update-staff-credentials', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                const result = await response.json();

                if (result.success) {
                    showMessageModal('ðŸŽ‰', result.message);
                    setTimeout(() => {
                        window.location.href = result.redirect;
                    }, 1500);
                } else {
                    showMessageModal('ðŸ˜”', result.message);
                }
            } catch (error) {
                showMessageModal('ðŸ›‘', 'Failed to update credentials.');
            }
        });
    }

    // --- FORGOT PASSWORD HANDLERS ---
    if (forgotPasswordModal) {
        forgotPasswordModal.addEventListener('hidden.bs.modal', () => {
            forgotStep1.classList.remove('d-none');
            forgotStep2.classList.add('d-none');
            forgotStep3.classList.add('d-none');
            forgotStaffIdInput.value = '';
            currentForgotStaffId = '';
        });
    }

    if (forgotNextBtn) {
        forgotNextBtn.addEventListener('click', async () => {
            const staff_id = forgotStaffIdInput.value.trim();
            if (!staff_id) {
                showMessageModal('Error', translations[currentLang].errors.enterStaffId);
                return;
            }
            currentForgotStaffId = staff_id;

            try {
                const response = await fetch('/api/staff/forgot-password/verify-staff-id', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ staff_id })
                });
                const result = await response.json();

                if (result.success && result.securityQuestion) {
                    renderForgotStep2(result.securityQuestion);
                } else {
                    showMessageModal('Error', result.message);
                }
            } catch {
                showMessageModal('Error', 'Failed to verify Staff ID.');
            }
        });
    }

    const renderForgotStep2 = (question) => {
        forgotStep2.innerHTML = `
            <p data-translate="answerQuestion"></p>
            <p class="fw-bold">${question}</p>
            <label data-translate="securityAnswer"></label>
            <input id="securityAnswerInput" class="form-control mb-3">
            <button id="verifyAnswerBtn" class="btn btn-primary w-100" data-translate="verify"></button>
            <button type="button" class="btn btn-link w-100 mt-2" onclick="document.getElementById('forgotStep2').classList.add('d-none'); document.getElementById('forgotStep1').classList.remove('d-none');" data-translate="back"></button>
        `;
        forgotStep1.classList.add('d-none');
        forgotStep2.classList.remove('d-none');
        translatePage(currentLang);

        document.getElementById('verifyAnswerBtn').addEventListener('click', async () => {
            const securityAnswer = document.getElementById('securityAnswerInput').value;
            if (!securityAnswer) {
                showMessageModal('Error', translations[currentLang].errors.emptyAnswer);
                return;
            }
            try {
                const response = await fetch('/api/staff/forgot-password/verify-answer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ staff_id: currentForgotStaffId, securityAnswer })
                });
                const result = await response.json();

                if (result.success) {
                    renderForgotStep3();
                } else {
                    showMessageModal('ðŸ”’', result.message);
                }
            } catch {
                showMessageModal('Error', 'Failed to verify security answer.');
            }
        });
    };

    const renderForgotStep3 = () => {
        forgotStep3.innerHTML = `
            <h5 data-translate="resetPasswordTitle"></h5>
            <p data-translate="newPasswordPrompt"></p>
            <label data-translate="newPasswordLabel"></label>
            <input type="password" id="resetPasswordInput" class="form-control mb-3" minlength="6" required>
            <button type="submit" class="btn btn-success w-100" data-translate="resetPasswordBtn"></button>
        `;
        forgotStep2.classList.add('d-none');
        forgotStep3.classList.remove('d-none');
        translatePage(currentLang);

        forgotStep3.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newPassword = document.getElementById('resetPasswordInput').value;
            if (newPassword.length < 6) {
                showMessageModal('Error', translations[currentLang].errors.passwordShort);
                return;
            }
            try {
                const response = await fetch('/api/staff/forgot-password/reset-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ staff_id: currentForgotStaffId, newPassword })
                });
                const result = await response.json();

                if (result.success) {
                    showMessageModal('ðŸŽ‰', result.message);
                    bootstrap.Modal.getInstance(forgotPasswordModal).hide();
                    setTimeout(() => window.location.href = result.redirect || '/staff-login', 1500);
                } else {
                    showMessageModal('ðŸ™', result.message);
                }
            } catch {
                showMessageModal('ðŸ›‘', 'Failed to reset password.');
            }
        });
    };

    // --- PASSWORD TOGGLE ---
    const setupPasswordToggle = (toggleId, inputId) => {
        const toggle = document.getElementById(toggleId);
        const input = document.getElementById(inputId);
        if (toggle && input) {
            toggle.addEventListener('click', () => {
                const type = input.type === 'password' ? 'text' : 'password';
                input.type = type;
                toggle.querySelector('i').classList.toggle('fa-eye');
                toggle.querySelector('i').classList.toggle('fa-eye-slash');
            });
        }
    };

    setupPasswordToggle('togglePassword', 'password');
    setupPasswordToggle('toggleNewPassword', 'newPasswordInput');
});